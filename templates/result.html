{% extends "index.html" %} 
{% block content %}
<style>
  button {
    width: 150px;
    height: 30px;
  }

  .container {
            margin-left: 15%;
            padding: 0 20px;
            padding-bottom: 60px;
  }
</style>

<script>
  //CSV 생성 함수
function saveCSV(fileName, link_id, table_id){
  //CSV 문자열 생성
  let downLink = document.getElementById(link_id);
  let csv = ''; //CSV최종 문자열을 저장하는 변수

  let table_tr = "#" + table_id + " tr"
  let rows = document.querySelectorAll(table_tr); // 테이블에서 행 요소들을 모두 선택

  //행단위 루핑
  for (var i = 0; i < rows.length; i++) {
      let cells = rows[i].querySelectorAll("td, th");
      let row = [];
      //행의 셀 값을 배열로 얻기
      cells.forEach(function(cell){
        row.push(cell.innerHTML);
      });

      csv += row.join(',') + (i != rows.length-1 ? '\n':''); // 배열을 문자열+줄바꿈으로 변환
  }

  //CSV 파일 저장
  csvFile = new Blob([csv], {type: "text/csv"}); // 생성한 CSV 문자열을 Blob 데이터로 생성
  downLink.href = window.URL.createObjectURL(csvFile); // Blob 데이터를 URL 객체로 감싸 다운로드 하이퍼링크에 붙임.
  downLink.download = fileName; // 인자로 받은 다운로드 파일명을 지정
}
</script>

<p style="margin-left: 15%">결과조회입니다</p>

<!--하이퍼링크 버튼-->
<div class="container">
  <button onclick="location.href = '{{ result_root }}scan/' ">
    파일 스캔
  </button>
  <button onclick="location.href = '{{ result_root }}single/' ">
    단일 결합
  </button>
  <button onclick="location.href = '{{ result_root }}multiple/' ">
    다중 결합
  </button>
</div>

<!--스캔 테이블 선택 화면-->
{% if  type == 'scan_select' %}
<div>SCANNED TABLES</div>

<table style = "margin-left: 15%">
  <!--테이블 각 열 설명-->
  <tr>
    <th>table name</th>
    <th>link button</th>
  </tr>

  <!--테이블 내용 채우기-->
  {% for table in table_rows %}
    <tr>
      {% for line in table %}
        <td>{{line}}</td>
        <td> <button onclick = "location.href = '{{result_root}}scan/{{line}}/'">{{ line }}</button> </td>
      {% endfor %}
    <tr>
  {% endfor %}

</table>

<!--스캔 결과 표시-->
{% elif type == 'scan_result' %}
  <!--csv파일 다운로드 버튼-->
    <button href ="" id = "numeric_download">수치속성 스캔결과 csv 다운로드</button>
    <button href ="" id = "categorical_download">범주속성 스캔결과 csv 다운로드</button>

  <!--숫자 스캔결과-->
    <div>Numeric Values</div>
    <table style = "margin-left: 15%" id = "numeric_result">
      <tr>
        <th>table name</th>
        <th>attribute name</th>
        <th>data type</th>
        <th>record_count</th>
        <th>distinct count</th>
        <th>null count</th>
        <th>null ratio</th>
        <th>zero count</th>
        <th>zero ratio</th>
        <th>min value</th>
        <th>max value</th>
        <th>is candidate</th>
      </tr>

      {% for row in numeric_rows%}
        <tr> 
            {% for val in row %}
              <td>{{val}}</td>
            {% endfor %}
        </tr>
      {% endfor %}
    </table>

  <!--문자 스캔결과-->
    <div>Categorical Values</div>
    <table style = "margin-left: 15%" id = "categorical_result">
      <tr>
        <th>table name</th>
        <th>attribute name</th>
        <th>data type</th>
        <th>record_count</th>
        <th>distinct count</th>
        <th>null count</th>
        <th>null ratio</th>
        <th>symbol count</th>
      </tr>

      {% for rows in categorical_rows%}
        <tr> 
            {% for vals in rows %}
              <td>{{vals}}</td>
            {% endfor %}
        </tr>
      {% endfor %}
    </table>

  <!--버튼을 통해서 csv 다운로드 받을 수 있게 연결-->
    <script>
      //수치 속성 다운로드 버튼 연결
      document.addEventListener('DOMContentLoaded', function(){
        document.getElementById('numeric_download').addEventListener('click', function(){
          let numerical_reuslt_file_name = "{{ table_name }}_numerical_scan.csv"
          saveCSV(numerical_reuslt_file_name,'numeric_download', 'numeric_result'); // CSV파일 다운로드 함수 호출
          return false;
        })
      });

      //범주 속성 다운로드 버튼 연결
      document.addEventListener('DOMContentLoaded', function(){
        document.getElementById('categorical_download').addEventListener('click', function(){
          let categorical_reuslt_file_name = "{{ table_name }}_categorical_scan.csv"
          saveCSV(categorical_reuslt_file_name,'categorical_download', 'categorical_result'); // CSV파일 다운로드 함수 호출
          return false;
        })
      });
    
    </script>
{% endif %}




{% endblock %}
