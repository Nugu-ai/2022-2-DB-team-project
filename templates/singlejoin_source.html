{% extends "index.html"  %}
{% block content %}
    <style>
        .title {
            margin-left: 15%;
            padding: 0 20px;
        }

        .container {
            margin-left: 15%;
            padding: 0 20px;
            padding-bottom: 60px;
        }

        table {
            border-collapse: collapse;
            font-size: 14.5px;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        thead {
            background: #bbdefb;
        }
        th {
            border: 1px solid black;
        }

        td {
            border: 1px solid black;
        }

    </style>
    <!-- <p style="margin-left:15%">단일 결합입니다</p> -->
    <h1 class="title">단일 결합</h1>
    <h3 class="title">Source 테이블 검색</h3>
    <div class="container">
        <table>
            <tr>
                <td style="background-color: #bbdefb;">테이블명</td>
                <td><input type="text" name="tablename" id="tablename" ></td>
                <td style="background-color: #bbdefb;">표준 결합키</td>
                <td>
                <select id="stdkey">
                    <option value="">선택 안함</option>
                    <option value="주민등록번호">주민등록번호</option>
                    <option value="전화번호">전화번호</option>
                    <option value="차량번호">차량번호</option>
                    <option value="이메일주소">이메일주소</option>
                    <option value="IP">IP</option>
                </select>
                </td>
                <td style="background-color: #bbdefb;">대표속성</td>
                <td>
                <select id="reprattr">
                    <option value="">선택 안함</option>
                    <option value="학업정보">학업정보</option>
                    <option value="금융정보">금융정보</option>
                    <option value="회원정보">회원정보</option>
                    <option value="건강정보">건강정보</option>
                </select>
                </td>
                <td style="background-color: #bbdefb;">속성명</td>
                <td><input type="text" name="attrname" id="attrname"></td>
            </tr>
        </table>
        <button class="button" onclick="search();">검색</button>
        <br>
        <br>
        <table>
            <thead>
                <tr>
                    <th>테이블 명</th>
                    <th>레코드 수</th>
                    <th>대표 속성</th>
                    <th>대표 결합키</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        <button onclick="redirectTo()">다음</button>
    </div>

    <script>
        let selectedElement;
        function search() {
            var tableName = document.getElementById('tablename').value
            var stdKey = document.getElementById('stdkey').value
            var reprAttr = document.getElementById('reprattr').value
            var attrName = document.getElementById('attrname').value
            
            var url = '/searchtable?scan=T&tname=' + tableName + '&jkey=' + stdKey + '&rattr=' + reprAttr + '&attr=' + attrName
     
            fetch(url)
            .then((res) => res.json())
            .then((data) => {
                let tbody = document.getElementById('tbody')

                let tr, tname, records, rattrs, rkeys
                for (const table of data) {
                    tr = document.createElement('tr');
                    tr.id = table["table_name"]
                    tr.onclick = () => {
                        if (selectedElement) document.getElementById(selectedElement).style.backgroundColor = 'white';
                        selectedElement = table["table_name"];
                        document.getElementById(selectedElement).style.backgroundColor = 'lightgray';
                    }
                    tname = document.createElement('td');
                    tname.innerHTML = table["table_name"];

                    records = document.createElement('td');
                    records.innerHTML = table["records"];

                    rattrs = document.createElement('td');
                    if (table["repr_attrs"].length > 1) {
                        rattrs.innerHTML = '';
                        for (const rattr of table["repr_attrs"]) {
                            rattrs.innerHTML += rattr + ', ';
                        }
                        rattrs.innerHTML = rattrs.innerHTML.slice(0, -2);

                    } else if(table["repr_attrs"].length == 1) {
                        rattrs.innerHTML = table["repr_attrs"];
                    } else {
                        rattrs.innerHTML = '-'
                    }
                    
                    rkeys = document.createElement('td');
                    if (table["join_keys"].length > 1) {
                        rkeys.innerHTML = '';
                        for (const rkey of table["join_keys"]) {
                            rkeys.innerHTML += rkey + ', ';
                        }
                        rkeys.innerHTML = rkeys.innerHTML.slice(0, -2);
                    } else if(table["join_keys"].length == 1) {
                        rkeys.innerHTML = table["join_keys"];
                    } else {
                        rkeys.innerHTML = '-'
                    }
                    
                    

                    tr.appendChild(tname);
                    tr.appendChild(records);
                    tr.appendChild(rattrs);
                    tr.appendChild(rkeys)

                    tbody.appendChild(tr);

                }
            })
        }
        function redirectTo() {
            console.log(selectedElement)
            if (selectedElement) window.location.href = '/singlejoin/' + selectedElement;
            else alert('선택된 테이블이 없습니다');
        }
        
    </script>
    
{% endblock %}